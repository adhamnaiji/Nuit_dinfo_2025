{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/adhem/OneDrive/Documents/Nuit%20d%27info/projet_nuit_digital_/Nuit_D_Info/stl-viewer-build/app/api/chat-stl/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\n\r\ninterface STLInfo {\r\n  name: string\r\n  size: number\r\n  isValid?: boolean\r\n  dimensions?: {\r\n    width: number\r\n    height: number\r\n    depth: number\r\n  }\r\n  triangles?: number\r\n}\r\n\r\nexport async function POST(request: Request) {\r\n  try {\r\n    const { messages, stlFileInfo } = await request.json()\r\n    \r\n    const apiKey = process.env.PERPLEXITY_API_KEY\r\n    if (!apiKey) {\r\n      return NextResponse.json(\r\n        { error: 'Cl√© API non configur√©e' },\r\n        { status: 500 }\r\n      )\r\n    }\r\n\r\n    console.log('\\nüì• === DONN√âES RE√áUES ===')\r\n    console.log('Messages:', messages.length)\r\n    console.log('STL Info:', stlFileInfo)\r\n\r\n    if (!Array.isArray(messages) || messages.length === 0) {\r\n      return NextResponse.json(\r\n        { error: 'Messages invalides' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    if (messages[messages.length - 1].role !== 'user') {\r\n      return NextResponse.json(\r\n        { error: 'Le dernier message doit √™tre de l\\'utilisateur' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // ‚úÖ ENHANCE USER MESSAGE WITH FILE INFO\r\n    let enhancedMessages = [...messages]\r\n    const lastMessageIndex = enhancedMessages.length - 1\r\n    const lastUserMessage = enhancedMessages[lastMessageIndex].content\r\n\r\n    if (stlFileInfo && stlFileInfo.name) {\r\n      const sizeKB = (stlFileInfo.size / 1024).toFixed(2)\r\n      const sizeBytes = stlFileInfo.size\r\n      const fileName = stlFileInfo.name\r\n      \r\n      const dimensionsText = stlFileInfo.dimensions \r\n        ? `Largeur: ${stlFileInfo.dimensions.width.toFixed(2)} mm, Hauteur: ${stlFileInfo.dimensions.height.toFixed(2)} mm, Profondeur: ${stlFileInfo.dimensions.depth.toFixed(2)} mm`\r\n        : 'Non disponibles'\r\n      \r\n      const trianglesText = stlFileInfo.triangles ? `${stlFileInfo.triangles}` : 'Non calcul√©'\r\n\r\n      // ‚úÖ ADD FILE INFO DIRECTLY TO USER MESSAGE\r\n      const fileContext = `\\n\\n[CONTEXTE DU FICHIER UPLOAD√â]\r\nFichier: ${fileName}\r\nTaille: ${sizeKB} KB (${sizeBytes} octets)\r\nDimensions: ${dimensionsText}\r\nTriangles: ${trianglesText}`\r\n\r\n      enhancedMessages[lastMessageIndex] = {\r\n        role: 'user',\r\n        content: lastUserMessage + fileContext\r\n      }\r\n\r\n      console.log('üìù Message am√©lior√© avec contexte fichier:')\r\n      console.log(enhancedMessages[lastMessageIndex].content)\r\n    }\r\n\r\n    // ‚úÖ BUILD SYSTEM PROMPT\r\n    const systemPrompt = `Tu es un expert en mod√©lisation 3D et fichiers STL. \r\nTu as acc√®s aux informations du fichier upload√© dans les messages de l'utilisateur.\r\nR√©ponds en fran√ßais, de mani√®re concise et pr√©cise.\r\nUtilise les donn√©es du fichier fournies pour r√©pondre aux questions.`\r\n\r\n    // ‚úÖ Build final messages\r\n    const finalMessages = [\r\n      { role: 'system', content: systemPrompt },\r\n      ...enhancedMessages\r\n    ]\r\n\r\n    console.log('üì§ Envoi √† Perplexity:')\r\n    console.log('   - Mod√®le: sonar-pro')\r\n    console.log('   - Messages totaux:', finalMessages.length)\r\n    console.log('   - Dernier message utilisateur:', enhancedMessages[lastMessageIndex].content.substring(0, 200))\r\n\r\n    const response = await fetch('https://api.perplexity.ai/chat/completions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${apiKey}`,\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify({\r\n        model: 'sonar-pro',\r\n        messages: finalMessages,\r\n        max_tokens: 1024,\r\n        temperature: 0.7\r\n      })\r\n    })\r\n\r\n    const data = await response.json()\r\n\r\n    console.log('üì• R√©ponse Perplexity:', response.status)\r\n\r\n    if (!response.ok) {\r\n      console.error('‚ùå Erreur API:', data.error)\r\n      return NextResponse.json(\r\n        { error: data.error?.message || 'Erreur API Perplexity' },\r\n        { status: response.status }\r\n      )\r\n    }\r\n\r\n    const reply = data.choices[0].message.content\r\n    console.log('‚úÖ R√©ponse:', reply.substring(0, 150) + '...\\n')\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      reply: reply\r\n    })\r\n\r\n  } catch (error) {\r\n    console.error('‚ùå Erreur serveur:', error)\r\n    return NextResponse.json(\r\n      { error: 'Erreur serveur interne: ' + (error instanceof Error ? error.message : 'Inconnu') },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}"],"names":[],"mappings":"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"}}]
}